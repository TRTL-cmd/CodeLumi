2026-01-31 Lumi Technical Daily Log
=================================

Purpose
-------
This file records technical, low-level steps, patches applied today, exact code paths touched, diagnostic outputs observed, and a precise debugging plan to be executed next. It's aimed at maintainers and engineers who will pick up token-propagation, IPC deduplication, and build stability tasks tomorrow.

Work completed (engineer-focused)
---------------------------------
1) Safe IPC initialization
  - File: `/src/main.ts`
  - Change: Added `safeInitHandlers(initFn, path, name)` to ensure handler registration is idempotent and to suppress duplicate `ipcMain.handle` warnings.
  - Observed: Duplicate IPC warning for `session:listArchives` persisted in logs — mitigation in place but still seeing a duplicate trace; next step: search for multiple calls to the initialize function and guard them.

2) Personality engine
  - File: `/src/core/personality/PersonalityEngine.ts` (new)
  - Exposed via: `(global as any).lumiRAG.getPersonality()`.
  - Renderer APIs added in `/src/preload.ts`: `window.lumi.rag.recordPositive`, `window.lumi.rag.recordNegative`.
  - Headless smoke test: `scripts/headless_personality_test.js` executed after small patch; `initializeRAG()` returned `{ ok: true, indexed: 0 }` with expected state transitions on `recordPositive/Negative`.

3) Expertise module and RAG prompt enrichment
  - File: `/src/brain/lumi-expertise.ts` (new)
  - Purpose: detect languages from queries, provide code-generation instructions, and append expert guidance to the system prompt.
  - Integration: `brain-rag-integration.ts` now calls `enhancePromptWithExpertise()` when a code request is detected.

4) Token-budgeting and LLM instrumentation
  - Files touched:
    - `/src/core/brain/index.ts` — added `detectCodeRequest()` and `detectLanguage()` helpers; compute `options.num_predict` based on language; log `options.num_predict` just before LLM call.
    - `/src/core/brain/brain-rag-integration.ts` — detect code requests, set `options.num_predict`, and add code instructions to prompt.
    - `/src/core/llm/ollama.ts` — added debug logging inside `generate()` and `chat()` to log model name and `num_predict`/`maxTokens` values sent to Ollama.
  - Observed: Logs exist in `dist` and compiled files, but live confirmation requires a stable dev-mode run or capturing the packaged process logs where the main process prints them.

5) Security: fenced-code detection
  - File: `/src/security/threat_detection.ts`
  - Change: Added `hasFencedCode` guard and suppressed the `code-like` and `many-urls` flags when valid fenced code blocks are present, to avoid quarantining legitimate code examples.
  - Rationale: Assistant-provided code should not be auto-quarantined when the content clearly contains fenced code blocks.

6) UI & curator fixes
  - File: `/src/components/security/SecurityCurator.tsx`
  - Change: Use `window.lumi.staging.approve/reject` if exposed, and `await refresh()` to update UI state after approve/reject.

7) Diagnostics and scripts
  - Files: `scripts/headless_personality_test.js`, `run-diagnostics.ps1`, `check-compiled-logs.ps1` added.
  - Purpose: headless checks for RAG/personality initialization and quick searches of compiled dist logs to confirm instrumentation.

Build and runtime observations (concrete)
---------------------------------------
- TypeScript compilations (`npx tsc -p tsconfig.json`) completed cleanly after code edits and patch iterations.
- Vite build (`npm run build`) completed; however `index.html` references `dist/components/AutoCodeBox.js` which was not present in the packaged `dist` causing `ENOENT` during packaged start.
- Packaged start logs showed:
  - RAG init messages and `Personality IPC signals wired`.
  - Duplicate IPC registration warning: `session:listArchives` (investigate multiple initializations).
  - No consistent `num_predict` logs observed in live runs due to dev-mode instability; Ollama wrapper logs were present in compiled sources.

Repro steps attempted today
--------------------------
1. `npx tsc -p tsconfig.json` — verify compile (success)
2. `npm run build` — bundle frontend (success)
3. `npm start` — packaged start (saw RAG init logs; initial run crashed due to missing AutoCodeBox)
4. `npm run dev:electron` — attempted multiple times; dev terminal closed unexpectedly before we could confirm live Ollama `num_predict` logs.
5. `node scripts/headless_personality_test.js` — executed; initial script fix applied (remove TypeScript cast that node couldn't parse), reran, and validated RAG/personality flow.

Key runtime log lines to look for (when running successfully)
---------------------------------------------------------
- "[RAG] Code request for Haskell, using 3500 tokens" — indicates high token budget selection.
- "[Brain] CALLING OLLAMA - options.num_predict=3500" — brain instrumentation before network call.
- "[Ollama] chat called - model=... num_predict=..." — Ollama wrapper logging showing final values sent.

Today’s unresolved items (investigate first)
-------------------------------------------
1. Dev-mode instability (most critical): investigate why `npm run dev:electron` closes the terminal. Possible causes:
   - Missing terminal keep-alive flags or tasks in the dev script.
   - Unhandled exceptions in the main process that terminate Electron.
   - External tooling interfering with the terminal process (antivirus / OneDrive activity).
   - Action: run dev-mode inside a persistent Windows Terminal / PowerShell session and capture stdout/stderr to a file:

```powershell
npm run dev:electron > dev-electron.log 2>&1
Get-Content dev-electron.log -Wait
```

2. Find duplicate IPC registration origin:
   - Search for all `ipcMain.handle`, `ipcMain.on`, and init functions that register handlers. Ensure `initializeArchivesHandlers` is only called once.
   - Run:

```powershell
Select-String -Path src\**\*.ts -Pattern "ipcMain.handle|initializeArchivesHandlers|session:listArchives" -SimpleMatch -List
``` 

3. AutoCodeBox missing in `dist`:
   - Either guard the `index.html` import so packaged start doesn't fail, or ensure AutoCodeBox is included in the Vite build output.
   - Quick guard suggestion in `index.html`:

```html
<!-- optional guard -->
<script>
  try {
    const s = document.createElement('script')
    s.src = './components/AutoCodeBox.js'
    s.onload = () => console.log('AutoCodeBox loaded')
    document.head.appendChild(s)
  } catch(e) { console.warn('AutoCodeBox import skipped', e) }
</script>
```

Planned debug checklist for tomorrow (step-by-step)
--------------------------------------------------
1. Reproduce dev-mode termination with stdout redirected to a log file; capture stack traces or termination signals.
2. If dev-mode remains unreliable, run packaged start with guarded AutoCodeBox import and tail the main process logs for the key log lines listed above.
3. Add an ephemeral high-verbosity log just before the function that returns assistant outputs (the final assembly point after RAG/brain/LLM) so we can confirm the exact call sequence during a code-generation prompt.
4. Run a reproducible test prompt (Haskell parser example) and verify the entire code block appears in the renderer/editor with no truncation.
5. Search and remove duplicate IPC registration sources; add unit tests or init checks to prevent double registration going forward.

Quick code grep references (helpful paths)
-----------------------------------------
- `src/main.ts` — app initialization and IPC registration
- `src/preload.ts` — renderer-safe exposed APIs
- `src/core/brain/index.ts` — `think()` entry and token budgeting
- `src/core/llm/ollama.ts` — LLM wrapper and network call instrumentation
- `src/security/threat_detection.ts` — fenced code detection logic
- `src/brain/lumi-expertise.ts` — expertise rules and prompt enrichers

Final notes
-----------
- Today made strong progress on safety, personality, and token-budget instrumentation. The remaining blockers are primarily runtime – dev-mode instability and the missing AutoCodeBox in production — both should be solvable with the above reproduce-and-capture steps.

Addendum — End-of-day updates and immediate next actions
--------------------------------------------------------
Additional work completed after the main edits above:
- Inline curator enhancements added to `index.html` to safely render persisted suggestions and provide a Preview/Apply modal.
- A React-based `SecurityCurator` component was implemented in `src/components/security/SecurityCurator.tsx`, compiled to `dist/components/security/SecurityCurator.js`, and patched to expose the compiled export to `window.SecurityCurator` as a quick runtime mount option.
- A dynamic loader IIFE was added to `index.html` to load and mount the compiled React curator into `#curatorReactMount` when present; a previous nested-script parsing error was fixed by inlining and sanitizing the loader.
- LLM request body shape was corrected so `options` are nested (e.g., `body.options.num_predict`) ensuring token-budget and `num_predict` values propagate down to the Ollama wrapper.
- KB search and self-learn agent improvements (tokenized scoring, persistence of embeddings, selflearn audit lines, and learning-event emit to renderer) were applied and wired into the ingest pipeline.

Immediate verifications performed or requested by the user:
- Confirmed `window.lumi.listSuggestions()` returns suggestion arrays (user saw ~17,877 suggestions). 
- Confirmed `#curatorReactMount` exists in the renderer DOM (the inline fallback UI renders when React global was not observed).
- Observed `window.SecurityCurator` was `undefined` in the user's runtime checks — likely due to module scoping or the compiled bundle not evaluating globally in that environment. The dynamic loader and dist patch were applied to make this robust; please restart the app and re-check.

Concrete next steps to start tomorrow (priority ordering)
1. Reproduce dev-mode termination and capture logs (critical):
  - Run dev-mode with stdout/stderr redirected and tail the file in real time to capture stack traces:

```powershell
npm run dev:electron > dev-electron.log 2>&1
Get-Content dev-electron.log -Wait
```

2. Confirm Ollama token propagation during an interactive code request (Haskell/Rust test prompts) and look for these log lines:
  - "[Brain] CALLING OLLAMA - options.num_predict=..."
  - "[Ollama] chat called - model=... num_predict=..."

3. Locate and remove duplicate IPC registration(s) (e.g., `session:listArchives`) by searching all `ipcMain.handle` and initialization call sites:

```powershell
Select-String -Path src\\**\\*.ts -Pattern "ipcMain.handle|initializeArchivesHandlers|session:listArchives" -SimpleMatch -List
```

4. Guard or include `AutoCodeBox` in production builds:
  - Option A (quick): Add a runtime guard in `index.html` before importing `dist/components/AutoCodeBox.js`.
  - Option B (preferred): Ensure the component is part of the Vite build output so `dist` contains it.

5. If `window.SecurityCurator` remains undefined after an app restart, either:
  - Rebuild the frontend (`npm run build`) and repackage, or
  - As a short-term fix, ensure the compiled `dist/components/security/SecurityCurator.js` is loaded by the dynamic loader and exposes `window.SecurityCurator` (already patched, but may need verifying in the packaged environment).

6. Add an ephemeral high-verbosity log just before the final assistant output assembly (to confirm the instrumented brain/Ollama call path is actually reached during interactive flows).

Optional/next-phase items (can start after the above)
- Replace the runtime-global exposure with proper ES module imports and a Vite-based island bundling for `SecurityCurator` (cleaner long-term fix).
- Integrate the provided production utilities (`lumi-logger.ts`, `health-monitor.ts`, `backup-manager.ts`) into `main.ts`/`preload.ts` and wire IPC endpoints for health and backups.
- Add unit or integration tests that catch duplicate IPC registrations and validate the `num_predict` value is forwarded to the Ollama client in CI.

Files to inspect for follow-up (quick links):
- [docs/logs/daily/2026-01-31.md](docs/logs/daily/2026-01-31.md)
- [docs/logs/lumi_daily_logs/2026-01-31.md](docs/logs/lumi_daily_logs/2026-01-31.md)

If you'd like, I can (a) run the grep for duplicate IPC handlers and propose a patch; (b) add the AutoCodeBox guard to `index.html` now; or (c) patch `dist/components/security/SecurityCurator.js` again to force global exposure. Which should I do next?

2026-01-31 Lumi Technical Daily Log
=================================

Purpose
-------
This file records technical, low-level steps, patches applied today, exact code paths touched, diagnostic outputs observed, and a precise debugging plan to be executed next. It's aimed at maintainers and engineers who will pick up token-propagation, IPC deduplication, and build stability tasks tomorrow.

Work completed (engineer-focused)
---------------------------------
1) Safe IPC initialization
  - File: `/src/main.ts`
  - Change: Added `safeInitHandlers(initFn, path, name)` to ensure handler registration is idempotent and to suppress duplicate `ipcMain.handle` warnings.
  - Observed: Duplicate IPC warning for `session:listArchives` persisted in logs — mitigation in place but still seeing a duplicate trace; next step: search for multiple calls to the initialize function and guard them.

2) Personality engine
  - File: `/src/core/personality/PersonalityEngine.ts` (new)
  - Exposed via: `(global as any).lumiRAG.getPersonality()`.
  - Renderer APIs added in `/src/preload.ts`: `window.lumi.rag.recordPositive`, `window.lumi.rag.recordNegative`.
  - Headless smoke test: `scripts/headless_personality_test.js` executed after small patch; `initializeRAG()` returned `{ ok: true, indexed: 0 }` with expected state transitions on `recordPositive/Negative`.

3) Expertise module and RAG prompt enrichment
  - File: `/src/brain/lumi-expertise.ts` (new)
  - Purpose: detect languages from queries, provide code-generation instructions, and append expert guidance to the system prompt.
  - Integration: `brain-rag-integration.ts` now calls `enhancePromptWithExpertise()` when a code request is detected.

4) Token-budgeting and LLM instrumentation
  - Files touched:
    - `/src/core/brain/index.ts` — added `detectCodeRequest()` and `detectLanguage()` helpers; compute `options.num_predict` based on language; log `options.num_predict` just before LLM call.
    - `/src/core/brain/brain-rag-integration.ts` — detect code requests, set `options.num_predict`, and add code instructions to prompt.
    - `/src/core/llm/ollama.ts` — added debug logging inside `generate()` and `chat()` to log model name and `num_predict`/`maxTokens` values sent to Ollama.
  - Observed: Logs exist in `dist` and compiled files, but live confirmation requires a stable dev-mode run or capturing the packaged process logs where the main process prints them.

5) Security: fenced-code detection
  - File: `/src/security/threat_detection.ts`
  - Change: Added `hasFencedCode` guard and suppressed the `code-like` and `many-urls` flags when valid fenced code blocks are present, to avoid quarantining legitimate code examples.
  - Rationale: Assistant-provided code should not be auto-quarantined when the content clearly contains fenced code blocks.

6) UI & curator fixes
  - File: `/src/components/security/SecurityCurator.tsx`
  - Change: Use `window.lumi.staging.approve/reject` if exposed, and `await refresh()` to update UI state after approve/reject.

7) Diagnostics and scripts
  - Files: `scripts/headless_personality_test.js`, `run-diagnostics.ps1`, `check-compiled-logs.ps1` added.
  - Purpose: headless checks for RAG/personality initialization and quick searches of compiled dist logs to confirm instrumentation.

Build and runtime observations (concrete)
---------------------------------------
- TypeScript compilations (`npx tsc -p tsconfig.json`) completed cleanly after code edits and patch iterations.
- Vite build (`npm run build`) completed; however `index.html` references `dist/components/AutoCodeBox.js` which was not present in the packaged `dist` causing `ENOENT` during packaged start.
- Packaged start logs showed:
  - RAG init messages and `Personality IPC signals wired`.
  - Duplicate IPC registration warning: `session:listArchives` (investigate multiple initializations).
  - No consistent `num_predict` logs observed in live runs due to dev-mode instability; Ollama wrapper logs were present in compiled sources.

Repro steps attempted today
--------------------------
1. `npx tsc -p tsconfig.json` — verify compile (success)
2. `npm run build` — bundle frontend (success)
3. `npm start` — packaged start (saw RAG init logs; initial run crashed due to missing AutoCodeBox)
4. `npm run dev:electron` — attempted multiple times; dev terminal closed unexpectedly before we could confirm live Ollama `num_predict` logs.
5. `node scripts/headless_personality_test.js` — executed; initial script fix applied (remove TypeScript cast that node couldn't parse), reran, and validated RAG/personality flow.

Key runtime log lines to look for (when running successfully)
---------------------------------------------------------
- "[RAG] Code request for Haskell, using 3500 tokens" — indicates high token budget selection.
- "[Brain] CALLING OLLAMA - options.num_predict=3500" — brain instrumentation before network call.
- "[Ollama] chat called - model=... num_predict=..." — Ollama wrapper logging showing final values sent.

Today’s unresolved items (investigate first)
-------------------------------------------
1. Dev-mode instability (most critical): investigate why `npm run dev:electron` closes the terminal. Possible causes:
   - Missing terminal keep-alive flags or tasks in the dev script.
   - Unhandled exceptions in the main process that terminate Electron.
   - External tooling interfering with the terminal process (antivirus / OneDrive activity).
   - Action: run dev-mode inside a persistent Windows Terminal / PowerShell session and capture stdout/stderr to a file:

```powershell
npm run dev:electron > dev-electron.log 2>&1
Get-Content dev-electron.log -Wait
```

2. Find duplicate IPC registration origin:
   - Search for all `ipcMain.handle`, `ipcMain.on`, and init functions that register handlers. Ensure `initializeArchivesHandlers` is only called once.
   - Run:

```powershell
Select-String -Path src\**\*.ts -Pattern "ipcMain.handle|initializeArchivesHandlers|session:listArchives" -SimpleMatch -List
``` 

3. AutoCodeBox missing in `dist`:
   - Either guard the `index.html` import so packaged start doesn't fail, or ensure AutoCodeBox is included in the Vite build output.
   - Quick guard suggestion in `index.html`:

```html
<!-- optional guard -->
<script>
  try {
    const s = document.createElement('script')
    s.src = './components/AutoCodeBox.js'
    s.onload = () => console.log('AutoCodeBox loaded')
    document.head.appendChild(s)
  } catch(e) { console.warn('AutoCodeBox import skipped', e) }
</script>
```

Planned debug checklist for tomorrow (step-by-step)
--------------------------------------------------
1. Reproduce dev-mode termination with stdout redirected to a log file; capture stack traces or termination signals.
2. If dev-mode remains unreliable, run packaged start with guarded AutoCodeBox import and tail the main process logs for the key log lines listed above.
3. Add an ephemeral high-verbosity log just before the function that returns assistant outputs (the final assembly point after RAG/brain/LLM) so we can confirm the exact call sequence during a code-generation prompt.
4. Run a reproducible test prompt (Haskell parser example) and verify the entire code block appears in the renderer/editor with no truncation.
5. Search and remove duplicate IPC registration sources; add unit tests or init checks to prevent double registration going forward.

Quick code grep references (helpful paths)
-----------------------------------------
- `src/main.ts` — app initialization and IPC registration
- `src/preload.ts` — renderer-safe exposed APIs
- `src/core/brain/index.ts` — `think()` entry and token budgeting
- `src/core/llm/ollama.ts` — LLM wrapper and network call instrumentation
- `src/security/threat_detection.ts` — fenced code detection logic
- `src/brain/lumi-expertise.ts` — expertise rules and prompt enrichers

Final notes
-----------
- Today made strong progress on safety, personality, and token-budget instrumentation. The remaining blockers are primarily runtime – dev-mode instability and the missing AutoCodeBox in production — both should be solvable with the above reproduce-and-capture steps.

