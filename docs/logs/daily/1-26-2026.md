# Daily Log — 2026-01-26

## Summary

Today we focused on stabilizing Lumi’s learning/auto-merge pipeline, removing duplicate processing paths, hardening safety checks, repairing and deduplicating training/staging data, and validating the change by reproducing thumbs-up flows. The system is now running and producing deterministic single decisions for a single thumbs-up action (auto-merge OR quarantine) instead of multiple conflicting events.

## Major Outcomes (What we finished/completed)

1. **Duplicate processing removed**
   - Removed the fallback direct KB merge path in `src/main.ts` (`lumi-log-assistant`) which previously caused a direct KB merge in addition to routing to the `SignalProcessor`.
   - Ensured `lumi-log-assistant` is the canonical routing path to the `SignalProcessor` and made the call `await sp.processSignals(...)` (previously the call was fire-and-forget and there existed a parallel fallback that wrote directly to the KB).
   - Removed duplicate signal-processing triggers in the `memory-add` handler (both store.add branch and fallback append branch) so those do not re-send signals to the processor.
   - Result: single decision per thumbs-up in `userData/security/validation.jsonl` (observed auto_merge and quarantine duplicates reduced).

2. **Positive-feedback confidence defaults corrected**
   - `src/core/learning/extractor.ts`: raised default candidate confidence from `0.6` to `0.95` when a signal does not provide a confidence value. This avoids low-confidence quarantines for benign positive feedback.
   - Adjusted other producers so `lumi-log-assistant` preserves the passed confidence (used ~`0.92`/`0.95` as appropriate) and processor sees the higher confidence.

3. **Auto-approve and safety checks hardened**
   - Implemented scan-and-approve behavior that attempts to auto-approve matching staged items when high-confidence user positive feedback arrives. This is in `src/main.ts` (auto-approve pass scanning `StagingManager.loadStaging()` and calling `StagingManager.approve(...)`).
   - Implemented a post-approval safety scan in `src/core/security/staging-manager.ts` that runs `Threat.scanQA` on the approved QA. If the post-approval scan deems the entry suspicious it:
     - removes the KB entry (by id) from `training/lumi_knowledge.json` or `qa` root, if present,
     - writes an audit `userData/security/removed.jsonl` entry with `removedBy: 'auto-safety'`,
     - marks the staging item as `rejected` with `rejectionReason: 'auto_safety'`.
   - Also added high-threat immediate removal in the `SignalProcessor` (candidates with score > 30 are logged to `userData/security/removed.jsonl` and not staged).

4. **Deduplicate & repair scripts and runs**
   - Created and ran scripts to repair mojibake and normalize/dedupe both `training/lumi_knowledge.json` and `training/staging.jsonl`.
   - Example results seen earlier: `training/lumi_knowledge.json` deduped (e.g., 16→8), `training/staging.jsonl` deduped (e.g., 31→17→9 across runs). Backups were saved before edits.

5. **Curator UI safety improvement**
   - Replaced blocking `window.prompt()` usage in `src/components/security/SecurityCurator.tsx` with a DOM modal fallback (`askInput()`), avoiding issues in the sandboxed renderer.

6. **Diagnostics & logging**
   - Added noisy initialization logs and processor readiness diagnostics in `src/main.ts` to confirm `SignalProcessor` loading.
   - Implemented in-process validation log de-dup in `SignalProcessor` (60s window) to reduce rapid duplicate validation lines.

## Key Files Changed Today

- `src/main.ts`
  - Removed fallback direct-merge path.
  - Awaited `sp.processSignals(...)` and return error if processor missing.
  - Auto-approve logic improved to scan staging and approve matching QA on positive feedback, and boost confidence for explicit user UI flags.
  - Removed duplicated signal emission from `memory-add` branches.

- `src/core/learning/extractor.ts`
  - Default candidate confidence changed from `0.6` → `0.95`.

- `src/core/security/staging-manager.ts`
  - Post-approve safety scan added; suspicious auto-approvals are removed and logged.
  - `listPending` dedupe behavior retained/used by curator.

- `src/core/learning/processor.ts`
  - High-threat (>30) removal and audit logging.
  - Validation logging dedupe, `fixEncodingAndNormalize` usage on merge, and inclusive auto-merge threshold adjustments applied earlier.

- `src/components/security/SecurityCurator.tsx`
  - Replaced `prompt()` with `askInput()` DOM modal fallback.

- `scripts/`
  - `repair_kb_encoding.js`, `normalize_kb.js`, `dedupe_kb.js`, `dedupe_staging.js` created/used for offline data repairs and dedupe. Backups created prior to changes.

## Observed Evidence / Test Results

- `userData/security/validation.jsonl` now shows many single `auto_merge` entries where earlier duplicates (auto_merge + quarantine) occurred.
  - Example from log: a single `auto_merge` for "Good morning Lumi"; after fixes, thumbs-up actions produce only one decision in most reproduced tests.
- The file `validation.jsonl` still contains some earlier duplicate historical entries (these are pre-change and were audited). New testing shows the pathological duplication reduced or eliminated.

## Remaining Issues & What Still Needs Done

1. **Cleanup historical duplicates (optional)**
   - We deduped training/staging and the KB, but `validation.jsonl` contains historical duplicated decisions. If desired, run a compaction script to remove or compress historical duplicates (preserve a backed-up copy first). This is low priority — logs can remain as forensic records.

2. **Full test coverage and packaged build verification (high)**
   - We've verified the dev flow. We should run a full `npx tsc` build and create a packaged dev/CI artifact to ensure `dist/` matches `src/` edits and no compiled stale artifacts remain.
   - Confirm production packaging (Electron packaged app) still initializes `SignalProcessor` correctly and that `StagingManager` paths work in a packaged environment.

3. **Curator ergonomics (medium)**
   - Add UI affordances: bulk-approve safe items, show `removed.jsonl` history, and provide filters (confidence, threat_score) for curator review.
   - Consider a manual “final sign-off required” mode for thumbs-up where curator explicit approve is required rather than auto-approve.

4. **Tuning thresholds & heuristics (medium)**
   - We adjusted defaults (`0.95`), inclusive thresholds (`>=0.9`), and implemented auto-safety for post-approval scanning. These thresholds might need refinement based on longer-term telemetry and false positive/negative rates.

5. **Monitor and logging (ongoing)**
   - Add rotating logs and metrics reporting to track counts: auto_merge vs quarantine vs removed over time.
   - Add telemetry to log when an auto-approval is reverted by `auto-safety` and reasons (helpful to tune threat detection heuristics).

6. **Unit tests & integration tests (medium)**
   - Add unit tests for `Threat.scan*`, `StagingManager.approve/reject/listPending`, and `SignalProcessor.processSignals` behavior for known edge cases (duplicates, conflicting confidences).
   - Add integration tests that simulate thumbs-up flows and assert only one validation decision is written.

## Suggested Plan / Where to Start Tomorrow

**Priority A (tomorrow):**
- Run a full TypeScript build (`npx tsc`) and create the packaged dev Electron app to validate compiled `dist/` artifacts.
- Run a short smoke test suite: reproduce the thumbs-up flow, confirm `validation.jsonl` is single-entry per thumbs-up, confirm `training/staging.jsonl` not unexpectedly growing with duplicates.
- Verify `userData/security/removed.jsonl` contains only intentional removals from high-threat candidates or auto-safety reversions.

**Priority B (next 1-2 days):**
- Add integration tests for thumbs-up flows and for `StagingManager.approve` post-approval safety reversal.
- Implement curator UI improvements: "bulk-approve safe" and a view for `removed.jsonl`.
- Tune and document thresholds (e.g., auto-merge threshold, post-approval revoke threshold, confidence defaults).

**Priority C (future):**
- Add telemetry and dashboards to monitor auto_merge/quarantine/removed over time and spot regressions.
- Consider machine-learning based re-ranker for candidate auto-merge decisions (not required now).
- Add policy-based overrides and an enterprise admin panel for fine-grained control.

## Operational Notes / Safety

- All automated approvals and removals are audited: approvals set `approvedAt` and `approvedBy` (we add `auto-ui` on auto-approve), removals are logged to `userData/security/removed.jsonl` with `removedBy` set to `auto-safety` or `auto` as appropriate.
- Backups: when running offline KB dedupe/repair scripts we created backups of original files. Do not run destructive scripts without backups.
- The pipeline is conservative by design: when `Threat.scan*` is uncertain, items are quarantined. We added auto-approve on explicit user flags but still perform post-approval safety checks and can revert them.

## Files to Inspect / Commands

- Key files changed today:
  - `src/main.ts`
  - `src/core/learning/extractor.ts`
  - `src/core/security/staging-manager.ts`
  - `src/core/learning/processor.ts`
  - `src/components/security/SecurityCurator.tsx`
  - scripts in `scripts/` (repair/dedupe)

- Rebuild and test commands:
  - `npx tsc`
  - `npm run dev:electron`
  - Tail logs:
    - `Get-Content userData\\security\\validation.jsonl -Tail 40`
    - `Get-Content training\\staging.jsonl -Tail 40`
    - `Get-Content userData\\security\\removed.jsonl -Tail 40`

- If you want to reprocess existing quarantined staging safely (one-off):
  - I can prepare a script that scans `training/staging.jsonl` and calls `StagingManager.approve` for safe items (e.g., `threat_score === 0` and `confidence >= 0.9`) and moves them into the KB with backups/audit. We should run this only after you confirm the policy.

## Closing Notes

- **Status:** The system is running and the major bug causing duplicate decisions was fixed today. Thumbs-up flows now produce a single canonical decision in most tests.
- **Risk:** There are still historic duplicate entries in logs (left as forensic records). The new runtime behavior is correct and conservative: explicit user thumbs-up triggers auto-approve attempts; auto-approvals are validated by `auto-safety` and will be reverted if suspicious.

If you want, next I can:
- produce and run the safe reprocess script for staging (one-off, with backups), or
- implement the curator UI bulk-approve/removed-items view, or
- run a full build and produce a packaged dev artifact and a small automated test harness for thumbs-up flows.

— End of log
