# Lumi Daily Log — 2026-01-27 (Developer Journal)

This is a detailed developer-focused log covering everything changed, why, how to validate, and next technical moves.

## Morning — Setup and goals
- Goal: Harden the self-learning pipeline so UI toggles are deterministic and ensure no sensitive user info is persisted. Provide curator visibility in a sanitized form.
- Environment: Windows dev machine; `app.getPath('userData')` observed in logs as the runtime target for persisted files.

## Work performed (chronological + rationale)
1. Inspected current wiring
   - Read `src/main.ts`, `src/preload.ts`, `index.html`, `src/selflearning/safe-agent-deep.ts`, and `src/core/learning/knowledge-processor.ts` to find places where the agent starts/stops and where KB writes happen.
   - Observed: agent was instantiated at startup and only interval cleared on `stop()`, leaving in-flight LLM calls to finish and write results.

2. Deterministic stop behavior
   - Update: `src/selflearning/safe-agent-deep.ts`
     - Added `stopping: boolean` and `activeOps: number`.
     - Converted `stop()` to async and wait (bounded ~5s) for in-flight `activeOps` to finish.
     - Checked `this.stopping` at multiple heavy-work checkpoints (before generating knowledge/suggestions, before token decrement) so cancelled ticks bail early.
   - Why: ensures UI toggle proving "Off" actually prevents further learning writes.

3. Renderer single-click toggle
   - Update: `index.html` toggle logic now:
     - Disables the button while performing action.
     - Queries `selflearn:status` to determine running state.
     - Calls `selflearn.stop()` or `selflearn.start()` as appropriate, persists config via `selflearn:setConfig`, updates UI text, and says a short bubble message.
   - Also added a subscription to `window.lumi.onLearningEvent` to refresh metrics/KB count immediately on `kb-added` and suggestion events.

4. Main process coordination
   - Update: `src/main.ts` `selflearn:setConfig` now `await`s `agent.start()`/`agent.stop()` and emits `selflearn:started`/`selflearn:stopped`. This prevents race where renderer sees config persisted but agent still in-flight.

5. Privacy & staging hygiene
   - Update: `src/core/learning/knowledge-processor.ts`
     - `redact()` sanitizes emails, absolute Windows paths, unix-like absolute paths (long ones), and two-word capitalized names.
   - `file` field normalized to `displayFile` (project-relative when possible, else basename). This prevents storing `<USER_PATH>/...` while retaining useful provenance like `src/brain/proposal_generator.ts`.
   - Update: `src/main.ts` and `src/core/learning/processor.ts` now duplicate quarantine/staging writes into `userData/self-learn/staging.jsonl` *sanitized* replacing the `process.cwd()` occurrence with `[PROJECT_ROOT]` and stripping absolute Windows drive paths.
   - Rationale: keep a curator-friendly view in `userData/self-learn` without leaking user absolute paths.

6. KnowledgeProcessor ingestion robustness
   - Confirmed: ingest reads existing KB (handles both array and `{ qa: [...] }` shapes), dedupes by q+file display, writes canonical KB, self-learn copy, repo training copy, audit, memory additions, and validation logs.
   - Emits `lumi-learning-event` with `kb-added` payload so renderer can react.

7. Metrics & UI coherence
   - `index.html` updateScore() now coercively reads `totalKB` from metrics if available and displays that value; subscribes to learning events to refresh instantly.

## Files created / modified (summary)
- Modified:
  - `src/selflearning/safe-agent-deep.ts` (stop handling, stopping checks, activeOps)
  - `src/core/learning/knowledge-processor.ts` (redact, displayFile, ingestion flow)
  - `src/core/learning/processor.ts` (sanitized staging copies)
  - `src/main.ts` (await start/stop in setConfig; write sanitized staging copies on quarantine)
  - `index.html` (toggle behavior, event subscription, metrics coercion)
  - `src/preload.ts` (exposes selflearn APIs — previously present, verified)
- Created (dev inspection):
  - `userData/self-learn/` artifacts (audit, store, suggestions, progress, staging.jsonl)
  - `docs/logs/daily/2026-01-27.md` and `docs/logs/lumi_daily_logs/2026-01-27.md` (these files)

## Validation steps taken (manual checks performed)
- Ensured TypeScript compile (`npx tsc -p tsconfig.json`) and no TypeScript errors reported after patches.
- Confirmed code paths were instrumented with console logs that indicate start/stop and ingestion events.
- Manually traced `KnowledgeProcessor.ingest()` to ensure `file` is replaced with `displayFile` in audit and validation records.

## Outstanding issues & tech debt
1. Semantic deduplication (embeddings): still outstanding and high-priority to prevent duplicate knowledge blowup.
2. Curator improvements: batch ops and inline edits not implemented yet.
3. Unit/integration tests: absent — must be added to ensure no regressions.
4. Migration: existing `training/staging.jsonl` may contain absolute paths; a sanitization migration is available but not executed automatically.
5. Edge case: `displayFile` falls back to basename when `path.relative()` cannot produce a safe relative path — acceptable but may reduce traceability for non-repo files.

## Proposed plan for tomorrow (very specific)
1. Implement a one-time migration script that scans `training/staging.jsonl` and writes sanitized copies into `userData/self-learn/staging.jsonl` (no in-place rewrite unless explicitly approved). This addresses privacy for already-staged candidates.
2. Start scaffolding semantic deduplication in `KnowledgeProcessor`:
   - Add an embedding interface and local adapter (use Ollama text-embedding model if available) or a small local embedding library.
   - Compute embeddings for new candidates and run a nearest-neighbor check against an on-disk embedding index to decide merges.
3. Add unit tests:
   - `test/knowledge_processor.test.ts` covering redaction, duplicate detection by q+file, and sanitization of audit/validation records.
4. UX polish:
   - Add renderer toast notifications for `selflearn:started` / `selflearn:stopped` events.
   - Merge `kb-added` payloads into localStorage KB for immediate UI visibility (optional — care with duplicates).

## Commands & how to reproduce dev run
```bash
# Build
npx tsc -p tsconfig.json
# Run Ollama (if using model locally)
ollama serve
# Start dev Electron
npm run dev:electron
```

## Closing notes
- Current state: Autonomous learning pipeline is functional and now respects user toggle semantics and privacy constraints for persisted file metadata. The remaining high-impact work is semantic deduplication and curator UX improvements.

**Log completed by developer assistant on 2026-01-27**
