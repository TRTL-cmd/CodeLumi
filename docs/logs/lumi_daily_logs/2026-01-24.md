Lumi Daily Log — 2026-01-24

Overview
- This log captures Lumi's internal actions, KB usage, memory writes, reranker outputs observed during testing, and executor operations executed during the integration test.

Detailed action trace (chronological)
1) KB context assembly (brain)
- Trigger: `think()` / `thinkChat()` test invocation.
- Action: `src/core/brain/index.ts` built a `KB_CONTEXT` system message from top-k KB hits.
- Parsing: preference for parsed JSON fields `answer`/`output`/`a` when present; fallback to excerpt of `text`.
- Telemetry: `logKBUsage(query, hits, 'kbContext')` called. Expect entries appended to `userData/kb_usage.jsonl` with structure: `{query, hits:[{id,title,score}], source:'kbContext', ts}`.

2) KB retrieval behavior
- BM25 retrieval returned a ranked set of candidates (BM25 scores available in `src/core/memory/kb.ts`).
- Reranker: top BM25 candidates were sent to `scripts/rerank_candidates.py` which loaded `models/reranker.joblib` and returned per-candidate scores.
- Observed reranker top scores in one test run: ~0.5665 (indicates mid-confidence; requires thresholding policy).

3) Decision flow during tests
- Because `options.kbFirst` is enabled in tests and Ollama availability check failed for offline path, the brain returned KB-first synthesized answer formatted as `KB_ANSWER` block.
- Memory persistence: the chosen KB hits were also written to `userData/lumi_memory.jsonl` for future recall (this is done to allow Lumi to learn from used KB snippets).

4) Executor simulation and revert
- Executor simulated a write operation (created a file in a test sandbox), then executed it (created actual file under `tmp/` or a test-scoped path), then revert restored previous state using the saved backup.
- Auditor: executor wrote an audit entry with action details, timestamps, diff file path, and result status.

5) Signals & feedback
- Signal detector observed a simulated `positive_feedback` on the online LLM answer; `src/core/signal/detector.js` recorded a signal event that was persisted to memory.
- These positive feedback signals were later considered as high-priority candidates by the self-learning pipeline extractor plan.

Telemetry & artifacts
- KB loaded: 153 entries.
- Reranker: runs locally via Python wrapper; ensure venv has `numpy`, `joblib`, `scikit-learn`.
- Files to inspect after test runs:
  - `userData/kb_usage.jsonl` (KB usage records)
  - `userData/lumi_memory.jsonl` (memory entries produced by test)
  - `models/reranker.joblib` (reranker artifact; may be replaced during retrain)
  - `scripts/rerank_candidates.py` (wrapper)

Where to resume (clear-cut tasks)
- Implement `searchKBWithDecision()` that exposes `{hits, confidenceScore, recommendedAction: 'kb'|'ollama'}` for frontend and higher-level brain logic.
- Create a lightweight rule for combining BM25+reranker scores (e.g., normalized sum or logistic mapping) and a tunable threshold (start high e.g., 0.7).
- Add a `kbFirst` toggle in UI and wire an indicator showing whether the assistant is using KB-first fallback or Ollama.

Operational notes for operators
- When retraining the reranker, keep an evaluation holdout dataset and monitor precision@10. Only replace `models/reranker.joblib` when evaluation shows improvement or for a canary deploy.
- Keep `userData` write permissions limited and ensure backups before any bulk KB modifications.

Additional actions (later on 2026-01-24)
- Added local-only thinker `thinkLocal(prompt)` and `lumi-think-local` IPC to allow the app to answer purely from the KB when Ollama is unavailable.
- Exposed `kbReload` IPC and a `Reload KB` UI button to refresh the in-memory KB cache at runtime.
- Merged `training/lumi_knowledge.json` into `training/training.jsonl` (153 entries appended) and added safe merge tooling and inspection scripts.
- Patched packaged `dist-electron` preload/main fallback messaging to avoid instructing users to "Start Ollama" and to prefer neutral KB fallback outputs.

Next immediate test tasks
1. Restart Electron and run smoke tests with Ollama offline to confirm `thinkLocal` and KB fallback behavior end-to-end.
2. Calibrate decision thresholds: run decision tests across representative queries and tune `rerankerWeight` and `threshold`.
3. Aggregate telemetry from `userData/kb_usage.jsonl` and `userData/lumi_memory.jsonl` to validate candidate extraction coverage.
4. Implement `scripts/extract_candidates.js` to prepare `training/staging/` artifacts for human review.

Post-integration test notes (2026-01-24 afternoon)
- Decision logic implemented in `src/core/memory/kb.ts` and `DECISION_CONFIG.threshold` set to `0.60` for calibration.
- Ran `node scripts/test_search_decision.js "how to sort an array in javascript"` — recommendation: `ollama` (top hit final ≈ 0.626), indicating conservative behavior for this query.
- Ran `node scripts/extract_candidates.js` — Extraction found 0 candidates (memory entries: 6; signals: 1) in the current environment; staging summary file created under `training/staging/`.
- Ran `node scripts/telemetry_dashboard.js` — Telemetry snapshot: Memory entries: 6, KB queries: 0, Signals: 1. See `scripts/telemetry_dashboard.js` output for details.

End of Lumi daily log.
