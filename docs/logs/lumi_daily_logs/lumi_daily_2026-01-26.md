# Lumi Daily Log — 2026-01-26

Summary
-------
- Implemented a conservative auto-learning SignalProcessor pipeline and integrated it into the Electron main process.
- Added sanitization, threat detection, validation logging, and staging/curator hooks.
- Created a minimal `detector` shim so the app can start while a richer detector is being developed.
- Exposed staging APIs in preload (IPC-only fallbacks) and removed direct `fs` usage from the preload to avoid preload bundling errors.
- Added a KB normalizer script to deduplicate and unify `training/lumi_knowledge.json` entries.

What changed (high-level)
--------------------------
- `src/core/learning/processor.ts`: conservative auto-merge logic (scan.score < 10 && confidence > 0.9 && !suspicious); audit and KB merges; staging writes for quarantined items.
- `src/main.ts` and compiled `dist/main.js`: initialization of `SignalProcessor` and routing of renderer feedback to `global.lumiSignalProcessor` where available.
- `dist-electron/main.js`: built fallback attempts to route to `global.lumiSignalProcessor` and otherwise retains legacy direct-to-KB fallback.
- `src/preload.ts`: removed direct `fs`/`path` fallbacks so preload doesn't fail when bundled; relies on IPC and returns clear errors when IPC is unavailable.
- `src/core/signal/detector.ts`: minimal shim that returns no signals (safe default) so the runtime `require()` succeeds.
- `scripts/normalize_kb.js`: new normalizer to unify KB entries and deduplicate renderer-feedback vs auto-learning.

Files updated / created
----------------------
- Modified: `src/core/learning/processor.ts`, `src/preload.ts`, `src/main.ts` (compiled), `dist-electron/main.js`
- Added: `src/core/signal/detector.ts`, `scripts/normalize_kb.js`, `docs/*` (this log and change notes), `training/normalize_report.json` (generated by script)

How to reproduce (dev)
---------------------
1. Compile TypeScript:

```powershell
npx tsc -p tsconfig.json --outDir dist
```

2. Run dev build with Electron:

```powershell
npm run dev:electron 2>&1 | Tee-Object electron_diagnostic.log
Get-Content electron_diagnostic.log -Tail 300
```

3. To normalize/de-duplicate the KB:

```powershell
node scripts/normalize_kb.js
type training\normalize_report.json
```

Notes and observations
----------------------
- SignalProcessor initialization logs are present in `electron_diagnostic.log` (search for `SIGNALPROCESSOR READY`).
- Validation decisions are logged to `userData/security/validation.jsonl`.
- Auto-merged audit entries appear in `training/training.jsonl` and KB merges are written to `training/lumi_knowledge.json`.
- Older legacy `renderer-feedback` entries created before the SignalProcessor existed remain in the KB; use `scripts/normalize_kb.js` to reconcile.

Next steps
----------
1. Run the normalizer and review `training/normalize_report.json`.
2. Add curator authentication and gating if auto-merge should require manual approval.
3. Replace detector shim with a richer signal detector implementation.
4. Add CI step to compile `src/main.ts` when building dev/package so main edits are always applied.

— End of log

Update — 2026-01-26 (afternoon)
-------------------------------
- Performed a production web build (`vite build`) which regenerated `dist/` artifacts including `dist/preload.js`.
- Verified `src/preload.ts` exposes the new `selflearn` and `runSelflearnNow` APIs; observed that runtime Electron was loading a stale compiled preload (from `dist/preload.js`) so the renderer did not see those keys.
- Attempted to start Electron to reload the preload; startup failed in this environment due to an OS/terminal limit. Locally you can run `npm run start` or `npm run dev:electron` to pick up the new preload.
- Discovered packaged electron entry files are under `dist-electron/` (`dist-electron/main.js`, `dist-electron/preload.js`) while `package.json` `main` points to `dist/main.js`. This will cause "cannot find module dist/main.js" errors when starting Electron — either update `package.json` to `dist-electron/main.js` or copy `dist-electron/*` into `dist/`.

Next actions (short):
1. Restart Electron locally to verify `window.lumi.selflearn` and `runSelflearnNow` appear in DevTools.
2. Start the selflearn agent and/or run `runSelflearnNow()` to produce persisted `selflearn_*.jsonl` files under the app `userData` path.
3. Consider updating `package.json` `main` to `dist-electron/main.js` to match where Electron build outputs are currently placed.
