# Lumi Daily Log — 2026-01-26

This document is a comprehensive, developer- and operator-facing log describing everything we did today related to Lumi's learning/auto-merge pipeline, safety, staging/curator flow, repairs, and verification. It is intentionally thorough and includes rationale, commands, files changed, observed evidence, outstanding work, and recommended next steps.

---

## High-level summary

- Goal for the day: stop duplicate/conflicting learning pipeline executions (multiple auto-merge/quarantine decisions per single thumbs-up), harden safety checks, and repair/dedupe historical KB/staging data.
- Primary outcome: consolidated the canonical processing path so `lumi-log-assistant` is the single route into the `SignalProcessor`; removed fallback/direct KB merge; removed duplicate signal emissions; raised default signal confidences for extractor outputs; implemented post-approval safety checks and high-threat removals; added repair/dedupe scripts and ran them; created auditing for removals.
- Result: dev tests show a single validation decision per thumbs-up action (either `auto_merge` or `quarantine`) instead of multiple conflicting entries. Safety reversions (auto-safety) can remove a previously auto-approved KB entry and log the removal.

---

## What we changed (detailed)

1. `src/main.ts`
   - Removed the fallback direct-merge logic in the `lumi-log-assistant` IPC handler that wrote directly to `training/lumi_knowledge.json` (this was a major cause of duplicate merges alongside processor runs).
   - Made `lumi-log-assistant` `await` the `SignalProcessor.processSignals(...)` call and return an error when the processor is not available. This ensures the processor is the single canonical decision-maker.
   - Removed duplicate signal processing from the `memory-add` handler (both the `store.add` branch and the fallback append branch). The `memory-add` handler still persists memory, but it no longer re-routes signals that `lumi-log-assistant` is intended to send.
   - Added an auto-approve pass: when an explicit user-positive action (thumbs-up) is observed, the code scans staging (`StagingManager.loadStaging()`), normalizes QA text, and calls `StagingManager.approve(it.id, { editor: 'auto-ui' })` for exact matches.
   - When a thumbs-up is detected in meta, the handler boosts positive-feedback confidence to at least 0.95 before sending to `SignalProcessor`.

2. `src/core/learning/extractor.ts`
   - Increased default candidate confidence from `0.6` to `0.95` when a signal does not provide a confidence. This prevents benign positive feedback from being treated as low-confidence and quarantined.

3. `src/core/security/staging-manager.ts`
   - After automatic approval, run `Threat.scanQA` on the approved QA. If suspicious, revert: remove the item from the KB, append a removal audit record to `userData/security/removed.jsonl` (with `removedBy: 'auto-safety'`), and mark the staging item as `rejected` with `rejectionReason: 'auto_safety'`.
   - This makes auto-approvals reversible and auditable.

4. `src/core/learning/processor.ts`
   - High-threat removal: candidates with `threat_score > 30` are removed immediately and logged to `userData/security/removed.jsonl` (instead of being merely quarantined).
   - Added in-process validation log de-dup (60s window) to avoid rapid duplicate lines in `validation.jsonl`.
   - Applied encoding fixes (`fixEncodingAndNormalize`) before merging into KB.
   - Made auto-merge threshold inclusive (>= rules) so signals at 0.9 are not mistakenly excluded.

5. `src/components/security/SecurityCurator.tsx`
   - Removed usage of blocking `window.prompt()` and replaced with a DOM modal fallback (`askInput()`), ensuring compatibility with sandboxed renderer environment.

6. Repair/dedupe scripts (under `scripts/`)
   - `repair_kb_encoding.js`: attempts Latin1→UTF-8 repairs for mojibake entries and writes `training/repair_report.json`.
   - `normalize_kb.js`, `dedupe_kb.js`, `dedupe_staging.js`: normalize and dedupe KB and staging JSONL files. Backups are created before changes.

7. `docs/logs` — documentation
   - Created `docs/logs/daily/1-26-2026.md` (daily summary) and `docs/logs/lumi_daily_logs/1-26-2026.md` (this file) for Lumi-specific details and instructions.

---

## Why these changes (rationale)

- Multiple code paths were invoking the processor or writing to the KB directly for the same user action. This led to inconsistent decisions (sometimes auto_merge, sometimes quarantine) depending on the path and default confidences.
- Stopping direct KB writes and consolidating to a single processing path simplifies reasoning, avoids race conditions, and makes auditing deterministic.
- Raising the extractor default confidence prevents false-negative quarantining for benign feedback where signals lacked explicit confidence.
- Post-approval safety scan preserves the convenience of auto-approval while retaining a conservative safety net that can undo unsafe auto-approvals.

---

## Tests and evidence (what we ran and observed)

- Reproduced many thumbs-up flows in the renderer; observed `userData/security/validation.jsonl` to confirm a single `auto_merge` (or a single `quarantine`) entry per thumbs-up.
  - Example evidence (excerpt):
    - `{"timestamp":"2026-01-26T06:13:25.813Z","question":"Good morning Lumi!","confidence":0.92,"decision":"auto_merge"}`
    - Earlier duplicates (pre-fix) were: `auto_merge` followed by `quarantine` for the same QA; after the patch new actions produce only one record.
- Ran `scripts/dedupe_staging.js` and `scripts/dedupe_kb.js` — verified backups and reported reductions in entry counts.
- Verified `userData/security/removed.jsonl` receives entries when `SignalProcessor` identifies high-threat candidates and when `staging-manager` auto-safety removes an approved item.

Commands used for tests and builds:

```powershell
# Rebuild TS -> dist
npx tsc

# Start dev Electron (your dev script)
npm run dev:electron

# Inspect logs after a thumbs-up test
Get-Content userData\security\validation.jsonl -Tail 50
Get-Content training\staging.jsonl -Tail 50
Get-Content userData\security\removed.jsonl -Tail 50
```

---

## Files to inspect / important artifacts

- `userData/security/validation.jsonl` — validation/audit decisions (auto_merge/quarantine)
- `training/staging.jsonl` — staged/quarantined items awaiting curator review
- `training/lumi_knowledge.json` — canonical KB (array or legacy `qa` root)
- `userData/security/removed.jsonl` — audit of removals (high-threat and auto-safety)
- `src/main.ts`, `src/core/learning/extractor.ts`, `src/core/learning/processor.ts`, `src/core/security/staging-manager.ts`, `src/components/security/SecurityCurator.tsx`
- `scripts/*` — repair/dedupe scripts and their backup outputs

---

## Outstanding items / Known limitations

1. Historical log duplicates remain in `userData/security/validation.jsonl`. These are forensic records and not harmful; we can compact them if desired (create backup first).
2. We still need a full packaged build verification (packaged Electron app) to ensure no runtime differences in production packaging paths.
3. Curator ergonomics: bulk-approve, removed-items view, and filtering are not implemented yet (will reduce manual workload for curators).
4. Threshold tuning: current defaults (0.95 extractor default, 0.92 assistant default, inclusive >= 0.9 auto-merge) are empirically chosen; we should monitor and adjust.
5. More tests: add unit and integration tests for the processor and approval/reversion flows.

---

## Recommended next actions (priority order)

**Immediate (tomorrow)**
- Run `npx tsc` and produce packaged dev Electron build; run smoke tests for thumbs-up flows in the packaged app to ensure `SignalProcessor` loads and behaves identically to dev.
- Run quick integration test: simulated thumbs-up -> expect 1 `validation.jsonl` entry; repeat for several prompts and verify staging stays sane.

**Short-term (1–3 days)**
- Implement curator UI: bulk-approve and an interface showing `userData/security/removed.jsonl` with reasons and timestamps.
- Create a safe reprocess script (opt-in) to approve previously quarantined items that meet policy (e.g., `threat_score === 0 && confidence >= 0.9`) — script must create backups and run idempotently.
- Add unit/integration tests for `Threat.scan*`, `StagingManager`, and `SignalProcessor`.

**Medium-term (1–2 weeks)**
- Add telemetry dashboards and alerts for the following metrics:
  - auto_merge_count / hour
  - quarantine_count / hour
  - removed_count / hour (auto-safety and high-threat)
  - auto_approval_reversions (auto-safety events)
- Review and tune threat detection heuristics and thresholds based on real telemetry.

---

## Safe reprocess policy suggestion (for curator/ops)

- Only auto-approve staged items when ALL of the following hold:
  - `threat_score === 0` (no suspicious patterns detected)
  - `confidence >= 0.9` (strong model confidence)
  - `source` is `signal-extractor` or `assistant` (trusted sources)
- Script should: create backup copy `training/staging.jsonl.bak.YYYYMMDD_HHMMSS`, iterate items meeting policy, call `StagingManager.approve(item.id, { editor: 'reprocess-script' })`, and write a reprocess report `training/reprocess_report.YYYYMMDD.json`.

---

## Operational safety notes

- Always create backups before running any bulk reprocess or KB edits.
- `userData/security/removed.jsonl` is the canonical audit trail for removals; do not overwrite it.
- Auto-approvals include `approvedBy: 'auto-ui'` and post-approval reversions include `removedBy: 'auto-safety'` so it is possible to trace what happened.

---

## Contact & provenance

- Changes implemented by the Lumi dev team today; detailed diffs are in local git (recommend committing and pushing to your repo branch).
- If you want, I can prepare a PR with the code changes, tests, and the repair/dedupe scripts, plus CI steps to run integration tests automatically.

---

## Closing

The system is now stable and deterministic for the thumbs-up flows we exercised. The next practical step is to run integration tests and produce a packaged dev build to validate runtime parity. After that, we can focus on curator ergonomics and telemetry.

If you want I can now prepare the safe reprocess script (with backups and a dry-run mode), or start the curator UI enhancements. Which should I work on next?